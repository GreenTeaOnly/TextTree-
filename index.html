<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<link rel="stylesheet" href="./style.rwd.css" />
<link rel="stylesheet" href="./global.css" />
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tree &lt;-&gt; Text é›™å‘è½‰æ›å™¨</title>

</head>
<body>
<header>
  <span> Tree &lt;-&gt; Text é›™å‘è½‰æ›å™¨</span>
  <button class="toggle-theme" id="themeBtn">ğŸŒ™</button>
</header>
<main>
  <!-- å´é‚Šæ¬„ -->
  <button class="preview-toggle-btn" id="previewToggleBtn" title="é¡¯ç¤ºé è¦½">ğŸ‘ï¸</button>

  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>
    <div class="sidebar-content">
      <div>
        <label>è½‰æ›æ–¹å‘ï¼š</label>
        <select id="mode">
          <option value="treeToText">Tree To Text</option>
          <option value="textToTree">Text To Tree</option>
        </select>
        <span class="icon-only">ğŸ”„</span>
        <span class="tooltip">è½‰æ›æ–¹å‘</span>
      </div>
      <div>
        <label>è®€å–æª”æ¡ˆï¼š</label>
        <input type="file" id="fileInput" accept=".json,.txt">
        <span class="icon-only">ğŸ“‚</span>
        <span class="tooltip">è®€å–æª”æ¡ˆ</span>
      </div>
      <div>
        <label>è¼¸å…¥å…§å®¹ï¼š</label>
        <textarea id="inputArea" placeholder="è²¼ä¸Š JSON / ç¸®æ’æ–‡å­— / ç¬¦è™Ÿæ¨¹æ–‡å­—"></textarea>
        <span class="icon-only">ğŸ“</span>
        <span class="tooltip">è¼¸å…¥å…§å®¹</span>
      </div>
      <div>
        <label>è¼¸å‡ºæ ¼å¼ï¼š</label>
        <select id="saveFormat">
          <option value="txt">ç¬¦è™Ÿæ¨¹æ–‡å­— (.txt)</option>
          <option value="json">JSON (.json)</option>
        </select>
        <span class="icon-only">ğŸ’¾</span>
        <span class="tooltip">è¼¸å‡ºæ ¼å¼</span>
      </div>
      <button class="action-btn" id="downloadBtn">ä¸‹è¼‰çµæœ</button>
    </div>
    <div class="drag-handle" id="dragHandle"></div>
  </div>

  <!-- é è¦½å€ -->
  <div class="right-panel">
    <div class="tabs">
      <div class="tab active" data-format="symbol">ç¬¦è™Ÿæ¨¹</div>
      <div class="tab" data-format="json">JSON</div>
      <div class="tab" data-format="indent">ç¸®æ’æ–‡å­—</div>
    </div>
    <div class="tab-content">
      <button class="copy-btn" id="copyBtn">è¤‡è£½</button>
      <pre id="outputContent"></pre>
    </div>
  </div>
</main>

<script>
  let currentTree = null;
  let currentTab = "symbol";

  /* ä¸»é¡Œåˆ‡æ› */
  const body = document.body;
  const themeBtn = document.getElementById("themeBtn");
  themeBtn.onclick = () => {
    body.classList.toggle("dark");
    themeBtn.textContent = body.classList.contains("dark") ? "â˜€ï¸" : "ğŸŒ™";
    localStorage.setItem("theme", body.classList.contains("dark") ? "dark" : "light");
  };
  if(localStorage.getItem("theme")==="dark"){
    body.classList.add("dark");
    themeBtn.textContent = "â˜€ï¸";
  }

  /* å´é‚Šæ¬„åˆ‡æ› & å¯¬åº¦èª¿æ•´ */
  const sidebar = document.getElementById("sidebar");
  const sidebarToggle = document.getElementById("sidebarToggle");
  const dragHandle = document.getElementById("dragHandle");
  let isDragging = false;

  sidebarToggle.onclick = () => {
    if (sidebar.classList.contains("collapsed")) {
      sidebar.classList.remove("collapsed");
      sidebar.style.width = "300px"; // å±•é–‹é è¨­å¯¬åº¦
    } else {
      sidebar.classList.add("collapsed");
      sidebar.style.width = "60px"; // æŠ˜ç–Šå¯¬åº¦
    }
  };

  // æŠ˜ç–Šç‹€æ…‹ä¸‹é»æ“Šåœ–ç¤º â†’ å–æ¶ˆæ‘ºç–Š
  document.querySelectorAll(".sidebar-content > div").forEach(div=>{
    div.addEventListener("click", () => {
      if(sidebar.classList.contains("collapsed")) sidebar.classList.remove("collapsed");
    });
  });

  dragHandle.addEventListener("mousedown", (e) => {
    isDragging = true;
    document.body.style.userSelect = "none"; // ç¦æ­¢é¸å–æ–‡å­—
  });

  window.addEventListener("mouseup", (e) => {
    if (isDragging) {
      isDragging = false;
      document.body.style.userSelect = ""; // è§£é™¤ç¦æ­¢
    }
  });

  window.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    let newWidth = e.clientX;
    if (newWidth < 300) newWidth = 300;  // æ‹–æ‹‰æœ€å°300px
    if (newWidth > 600) newWidth = 600;  // æœ€å¤§600px
    sidebar.style.width = newWidth + "px";
    if (sidebar.classList.contains("collapsed")) {
      sidebar.classList.remove("collapsed");
    }
  });

  /* Tree/Text è½‰æ›é‚è¼¯ */
  function textToTree(lines) {
    if (!lines.length) return null;
    const root = { name: lines[0].trim(), children: [] };
    const stack = [root];
    const indentStack = [0];
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      const cleanLine = line.replace(/^[\sâ”‚â”œâ””â”€]+/, "");
      const indent = line.match(/^(\s*)/)[1].length;
      const name = cleanLine.trim();
      if (!name) continue;
      const node = { name, children: [] };
      while (indentStack.length && indent <= indentStack[indentStack.length - 1]) {
        stack.pop();
        indentStack.pop();
      }
      stack[stack.length - 1].children.push(node);
      stack.push(node);
      indentStack.push(indent);
    }
    return root;
  }
  function treeToSymbolText(node, prefix = "", isLast = true) {
    if (!node) return "";
    const pointer = isLast ? "â””â”€â”€ " : "â”œâ”€â”€ ";
    let line = prefix + pointer + node.name + "\n";
    const children = node.children || [];
    const newPrefix = prefix + (isLast ? "    " : "â”‚   ");
    children.forEach((child, i) => {
      line += treeToSymbolText(child, newPrefix, i === children.length - 1);
    });
    return line;
  }
  function treeToIndentText(node, indent = 0) {
    if (!node) return "";
    let line = " ".repeat(indent * 4) + node.name + "\n";
    (node.children || []).forEach(child => {
      line += treeToIndentText(child, indent + 1);
    });
    return line;
  }

  function parseInput() {
    const input = document.getElementById("inputArea").value.trim();
    if (!input) return null;
    try { return JSON.parse(input); }
    catch {
      return textToTree(input.split(/\r?\n/).filter(l => l.trim() !== ""));
    }
  }
  function updateOutput() {
    if (!currentTree) { document.getElementById("outputContent").textContent = ""; return; }
    let out = "";
    if (currentTab === "symbol") out = treeToSymbolText(currentTree);
    if (currentTab === "json") out = JSON.stringify(currentTree, null, 2);
    if (currentTab === "indent") out = treeToIndentText(currentTree);
    document.getElementById("outputContent").textContent = out;
    localStorage.setItem("input", document.getElementById("inputArea").value);
  }

  const previewPanel = document.querySelector(".right-panel");
  const previewToggleBtn = document.getElementById("previewToggleBtn");

  previewToggleBtn.addEventListener("click", () => {
    previewPanel.classList.toggle("active");
    previewToggleBtn.textContent = previewPanel.classList.contains("active") ? "éš±è—é è¦½" : "é¡¯ç¤ºé è¦½";
  });


// åˆå§‹æ‰‹æ©Ÿç‰ˆè‡ªå‹•éš±è—é è¦½ï¼ˆå¯é¸ï¼‰
if(window.innerWidth <= 480){
  previewPanel.classList.add("hidden");
  previewToggleBtn.textContent = "éš±è—é è¦½";
}


  /* è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡ç·¨è¼¯ */
  if(localStorage.getItem("input")){
    document.getElementById("inputArea").value = localStorage.getItem("input");
    currentTree = parseInput();
    updateOutput();
  }

  document.getElementById("inputArea").addEventListener("input", () => {
    currentTree = parseInput(); updateOutput();
  });
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      currentTab = tab.dataset.format;
      updateOutput();
    });
  });

  document.getElementById("copyBtn").onclick = () => {
    navigator.clipboard.writeText(document.getElementById("outputContent").textContent)
      .then(() => alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"));
  };
  document.getElementById("downloadBtn").onclick = () => {
    if (!currentTree) return alert("è«‹å…ˆè¼¸å…¥å…§å®¹ï¼");
    const format = document.getElementById("saveFormat").value;
    let content = "", filename = "result";
    if (format === "json") { content = JSON.stringify(currentTree, null, 2); filename += ".json"; }
    else { content = treeToSymbolText(currentTree); filename += ".txt"; }
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  };

  document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById("inputArea").value = ev.target.result;
      currentTree = parseInput(); updateOutput();
    };
    reader.readAsText(file);
  });
</script>
</body>
</html>
