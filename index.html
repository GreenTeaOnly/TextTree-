<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<link rel="stylesheet" href="./style.rwd.css" />
<link rel="stylesheet" href="./global.css" />
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tree &lt;-&gt; Text 雙向轉換器</title>

</head>
<body>
<header>
  <span> Tree &lt;-&gt; Text 雙向轉換器</span>
  <button class="toggle-theme" id="themeBtn">🌙</button>
</header>
<main>
  <!-- 側邊欄 -->
  <button class="preview-toggle-btn" id="previewToggleBtn" title="顯示預覽">👁️</button>

  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle">☰</button>
    <div class="sidebar-content">
      <div>
        <label>轉換方向：</label>
        <select id="mode">
          <option value="treeToText">Tree To Text</option>
          <option value="textToTree">Text To Tree</option>
        </select>
        <span class="icon-only">🔄</span>
        <span class="tooltip">轉換方向</span>
      </div>
      <div>
        <label>讀取檔案：</label>
        <input type="file" id="fileInput" accept=".json,.txt">
        <span class="icon-only">📂</span>
        <span class="tooltip">讀取檔案</span>
      </div>
      <div>
        <label>輸入內容：</label>
        <textarea id="inputArea" placeholder="貼上 JSON / 縮排文字 / 符號樹文字"></textarea>
        <span class="icon-only">📝</span>
        <span class="tooltip">輸入內容</span>
      </div>
      <div>
        <label>輸出格式：</label>
        <select id="saveFormat">
          <option value="txt">符號樹文字 (.txt)</option>
          <option value="json">JSON (.json)</option>
        </select>
        <span class="icon-only">💾</span>
        <span class="tooltip">輸出格式</span>
      </div>
      <button class="action-btn" id="downloadBtn">下載結果</button>
    </div>
    <div class="drag-handle" id="dragHandle"></div>
  </div>

  <!-- 預覽區 -->
  <div class="right-panel">
    <div class="tabs">
      <div class="tab active" data-format="symbol">符號樹</div>
      <div class="tab" data-format="json">JSON</div>
      <div class="tab" data-format="indent">縮排文字</div>
    </div>
    <div class="tab-content">
      <button class="copy-btn" id="copyBtn">複製</button>
      <pre id="outputContent"></pre>
    </div>
  </div>
</main>

<script>
  let currentTree = null;
  let currentTab = "symbol";

  /* 主題切換 */
  const body = document.body;
  const themeBtn = document.getElementById("themeBtn");
  themeBtn.onclick = () => {
    body.classList.toggle("dark");
    themeBtn.textContent = body.classList.contains("dark") ? "☀️" : "🌙";
    localStorage.setItem("theme", body.classList.contains("dark") ? "dark" : "light");
  };
  if(localStorage.getItem("theme")==="dark"){
    body.classList.add("dark");
    themeBtn.textContent = "☀️";
  }

  /* 側邊欄切換 & 寬度調整 */
  const sidebar = document.getElementById("sidebar");
  const sidebarToggle = document.getElementById("sidebarToggle");
  const dragHandle = document.getElementById("dragHandle");
  let isDragging = false;

  sidebarToggle.onclick = () => {
    if (sidebar.classList.contains("collapsed")) {
      sidebar.classList.remove("collapsed");
      sidebar.style.width = "300px"; // 展開預設寬度
    } else {
      sidebar.classList.add("collapsed");
      sidebar.style.width = "60px"; // 折疊寬度
    }
  };

  // 折疊狀態下點擊圖示 → 取消摺疊
  document.querySelectorAll(".sidebar-content > div").forEach(div=>{
    div.addEventListener("click", () => {
      if(sidebar.classList.contains("collapsed")) sidebar.classList.remove("collapsed");
    });
  });

  dragHandle.addEventListener("mousedown", (e) => {
    isDragging = true;
    document.body.style.userSelect = "none"; // 禁止選取文字
  });

  window.addEventListener("mouseup", (e) => {
    if (isDragging) {
      isDragging = false;
      document.body.style.userSelect = ""; // 解除禁止
    }
  });

  window.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    let newWidth = e.clientX;
    if (newWidth < 300) newWidth = 300;  // 拖拉最小300px
    if (newWidth > 600) newWidth = 600;  // 最大600px
    sidebar.style.width = newWidth + "px";
    if (sidebar.classList.contains("collapsed")) {
      sidebar.classList.remove("collapsed");
    }
  });

  /* Tree/Text 轉換邏輯 */
  function textToTree(lines) {
    if (!lines.length) return null;
    const root = { name: lines[0].trim(), children: [] };
    const stack = [root];
    const indentStack = [0];
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      const cleanLine = line.replace(/^[\s│├└─]+/, "");
      const indent = line.match(/^(\s*)/)[1].length;
      const name = cleanLine.trim();
      if (!name) continue;
      const node = { name, children: [] };
      while (indentStack.length && indent <= indentStack[indentStack.length - 1]) {
        stack.pop();
        indentStack.pop();
      }
      stack[stack.length - 1].children.push(node);
      stack.push(node);
      indentStack.push(indent);
    }
    return root;
  }
  function treeToSymbolText(node, prefix = "", isLast = true) {
    if (!node) return "";
    const pointer = isLast ? "└── " : "├── ";
    let line = prefix + pointer + node.name + "\n";
    const children = node.children || [];
    const newPrefix = prefix + (isLast ? "    " : "│   ");
    children.forEach((child, i) => {
      line += treeToSymbolText(child, newPrefix, i === children.length - 1);
    });
    return line;
  }
  function treeToIndentText(node, indent = 0) {
    if (!node) return "";
    let line = " ".repeat(indent * 4) + node.name + "\n";
    (node.children || []).forEach(child => {
      line += treeToIndentText(child, indent + 1);
    });
    return line;
  }

  function parseInput() {
    const input = document.getElementById("inputArea").value.trim();
    if (!input) return null;
    try { return JSON.parse(input); }
    catch {
      return textToTree(input.split(/\r?\n/).filter(l => l.trim() !== ""));
    }
  }
  function updateOutput() {
    if (!currentTree) { document.getElementById("outputContent").textContent = ""; return; }
    let out = "";
    if (currentTab === "symbol") out = treeToSymbolText(currentTree);
    if (currentTab === "json") out = JSON.stringify(currentTree, null, 2);
    if (currentTab === "indent") out = treeToIndentText(currentTree);
    document.getElementById("outputContent").textContent = out;
    localStorage.setItem("input", document.getElementById("inputArea").value);
  }

  const previewPanel = document.querySelector(".right-panel");
  const previewToggleBtn = document.getElementById("previewToggleBtn");

  previewToggleBtn.addEventListener("click", () => {
    previewPanel.classList.toggle("active");
    previewToggleBtn.textContent = previewPanel.classList.contains("active") ? "隱藏預覽" : "顯示預覽";
  });


// 初始手機版自動隱藏預覽（可選）
if(window.innerWidth <= 480){
  previewPanel.classList.add("hidden");
  previewToggleBtn.textContent = "隱藏預覽";
}


  /* 自動載入上次編輯 */
  if(localStorage.getItem("input")){
    document.getElementById("inputArea").value = localStorage.getItem("input");
    currentTree = parseInput();
    updateOutput();
  }

  document.getElementById("inputArea").addEventListener("input", () => {
    currentTree = parseInput(); updateOutput();
  });
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      currentTab = tab.dataset.format;
      updateOutput();
    });
  });

  document.getElementById("copyBtn").onclick = () => {
    navigator.clipboard.writeText(document.getElementById("outputContent").textContent)
      .then(() => alert("已複製到剪貼簿"));
  };
  document.getElementById("downloadBtn").onclick = () => {
    if (!currentTree) return alert("請先輸入內容！");
    const format = document.getElementById("saveFormat").value;
    let content = "", filename = "result";
    if (format === "json") { content = JSON.stringify(currentTree, null, 2); filename += ".json"; }
    else { content = treeToSymbolText(currentTree); filename += ".txt"; }
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  };

  document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById("inputArea").value = ev.target.result;
      currentTree = parseInput(); updateOutput();
    };
    reader.readAsText(file);
  });
</script>
</body>
</html>
